# レトロゲーム商品画像アップローダー 要件定義書（外部接続用）

---

## 1. 概要

このAPIは、n8n・FileMaker・Difyなど外部システムからアクセスされることを前提としたエンドポイント群である。主に以下の機能を提供する。

- GridFSから画像を取得（filename指定）
- 画像に含まれるバーコードを読み取り、JSON形式で返却

---

## 2. エンドポイント一覧

| メソッド | パス                                  | 機能概要                                     |
|----------|---------------------------------------|----------------------------------------------|
| GET      | `/external_api/images/{filename}`         | GridFSから画像を取得                         |
| POST     | `/external_api/barcode`                   | 画像からバーコードを解析                     |
| GET      | `/external_api/search_unuploaded_items`   | 未処理の商品アイテムを検索                   |
| PATCH    | `/external_api/mark_uploaded`             | 特定の画像を処理済みとしてマーク             |
| PATCH    | `/external_api/update_metadata`           | 商品のメタデータ（タイトル等）を更新         |


---

## 3. 各エンドポイント仕様

### 3.1 画像取得（GET）

- **URL**: `/external_api/images/{filename}`
- **メソッド**: `GET`
- **パラメータ**:
  - `filename`：取得対象の画像ファイル名（例：`buyer_001_001.jpg`）
- **レスポンス**:
  - 成功: `200 OK`（image/jpegなど画像データ本体）
  - 失敗: `404 Not Found`（JSONエラーメッセージ）

### 3.2 バーコード読取（POST）

- **URL**: `/external_api/barcode`
- **メソッド**: `POST`
- **ボディ**: `multipart/form-data` (key: `file`, value: 画像ファイル)
- **レスポンス**:
  - 成功: `200 OK` (バーコード情報を含むJSON)
    ```json
    {
      "barcodes": [
        { "type": "EAN13", "data": "4974365900502", "rect": [620, 929, 184, 45] }
      ]
    }
    ```
  - 失敗: `500 Internal Server Error`
  - 認識なし: `200 OK` (`"barcodes": []`)

### 3.3 未処理アイテム検索（GET）

- **URL**: `/external_api/search_unuploaded_items`
- **メソッド**: `GET`
- **パラメータ**:
  - `group_id` (Query Param): 検索対象のグループID
- **概要**: 指定された `group_id` の中で、まだ外部システムに連携されていない（`file_uploaded: false`）商品アイテムの一覧を返す。
- **レスポンス**: `200 OK`
  ```json
  {
    "items": [
      {
        "_id": "6859dd25354173dd1c64aa19",
        "group_id": "sample_01",
        "user_short_id": "77aepdkx",
        "title": "",
        "images": [
          { "filename": "...", "file_id": "...", "file_uploaded": false }
        ]
      }
    ]
  }
  ```

### 3.4 処理済みマーク（PATCH）

- **URL**: `/external_api/mark_uploaded`
- **メソッド**: `PATCH`
- **ボディ**: `application/json`
  ```json
  {
    "group_id": "sample_01",
    "filename": "sample_01_77aepdkx_20250624080247929867.jpg"
  }
  ```
- **概要**: 特定の画像の `file_uploaded` フラグを `true` に更新する。
- **レスポンス**:
  - 成功: `200 OK` (`{"message": "更新しました"}`)
  - 失敗: `404 Not Found`

### 3.5 メタデータ更新（PATCH）

- **URL**: `/external_api/update_metadata`
- **メソッド**: `PATCH`
- **ボディ**: `application/json`
  ```json
  {
    "_id": "6859dd25354173dd1c64aa19",
    "title": "新しいタイトル",
    "platform": "新しいプラットフォーム",
    "description": "新しい説明",
    "jan_code": "1234567890123",
    "status": "更新済み",
    "meta_added": true
  }
  ```
- **概要**: 商品のMongoDBドキュメントID (`_id`) を指定し、タイトルやJANコードなどのメタデータを更新する。指定されたフィールドのみが更新対象となる。
- **レスポンス**:
  - 成功: `200 OK` (`{"message": "更新しました", ...}`)
  - 失敗: `400 Bad Request` (ID形式不正など), `404 Not Found`


## 4. 利用想定システム

    n8n：

        HTTP Request ノードから画像送信し、バーコードを取得して処理分岐などに利用

    FileMaker：

        Web Viewer や外部HTTPリクエストスクリプトステップからの画像取得

    Dify：

        外部ファイルへのアクセスとして画像取得、または内容分析の前処理


## 5. ディレクトリ構成案（撮影者用と統一）

```
FastAPI_mongoDB/
├── main.py
├── db.py     ← MongoDB接続設定
├── routers/
│   ├── photographer.py
│   └── admin.py
├── services/
│   ├── image_processing.py
├── templates/
│   ├── index.html                ← ポータル画面（撮影者/管理者の選択）
│   ├── photographer/
│   │   └── upload.html
│   └── admin/
│       ├── dashboard.html
│       ├── generate_qr.html
│       ├── force_reset.html
│       ├── search.html
│       └── detail.html
├── static/
│   └── css/ js/（必要に応じて）
├── temp_images/
├── requirements.txt
└── requirements_spec.md
```

## 6. 将来的な拡張予定

    file_id による画像取得（filenameを隠蔽）

    MIME自動判定（png/webpなど対応）

    複数画像の一括取得やgroup_idによる絞り込み

    バーコード種別ごとの処理分岐

    認識結果の精度向上（画像補正やOCR併用）

## 7. 注意点

    GridFSに登録されたファイル名は一意である必要がある

    認識処理は白黒の明瞭な画像を前提としており、反射やボケのある画像では失敗することがある

    大量アクセスを想定する場合はCORSやレートリミットなどを追加すること