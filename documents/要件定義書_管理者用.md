# レトロゲーム商品画像アップローダー 要件定義書（管理者用）

---

## 1. 概要

撮影・登録された商品画像やメタデータを管理者が確認・管理できるWeb管理画面を提供する。

本アプリケーションにおける管理者には「システム管理者」と「運営者」の2種類が存在する。
- **システム管理者 (system_admin):** 最上位の管理者。運営者のアカウント管理や、システム全体のデータ整合性維持（孤立データ管理）などを行う。
- **運営者 (operator):** 撮影者の管理や撮影準備、自身に紐づく登録画像の管理など、日々の運用を担当する管理者。

この要件定義書では、主に「運営者」が使用する機能について記述する。

### データ分離の原則

本システムは複数運営者の利用を前提としており、各運営者が作成・管理するデータ（撮影者アカウント、画像グループ、画像データ）は、他の運営者からは完全に分離され、互いに閲覧・操作することはできない。

---

## 2. 機能要件（運営者）

### 2.1 撮影用URL/QRコード作成

- 運営者がgroup_id（買取先IDなど）を手動入力できる。
- 入力されたgroup_idと、自身を所有者として示す`operator_id`を含むURLを生成する。
- 生成されたURLを元にQRコードを作成し、その場でブラウザに表示する。

### 2.2 撮影者アカウント管理
- 運営者ダッシュボードから、自身が管理する撮影者アカウントの作成、一覧表示、削除ができる。
- 撮影者アカウントは、作成した運営者に紐づき、他の運営者からは管理されない。

### 2.3 登録済み画像の検索と詳細表示
- 自身に紐づく画像データを、`group_id`をキーとして検索・閲覧できる。
- UIは2階層構造をとり、まず`group_id`の一覧（フォルダ形式）が表示され、特定のグループを選択するとその中の画像一覧が表示される。
- 画像一覧の各アイテムをクリックすると、詳細ページに遷移し、登録されている最大10枚の画像とメタデータを確認可能。
- 詳細ページからアイテム（登録データ）を削除できる。

### 2.4 グループID毎の統計情報
- 自身に紐づく`group_id`ごとに、アップロード済み、未アップロードの件数を集計して表示する。
- アップロード率（％）も合わせて表示する。
- グループ単位で、登録されているすべての画像とメタデータを一括で削除する機能を持つ。

### 2.5 強制初期化
- 運営者が「初期化」を実行すると、GridFSに保存されている一時ファイル（`temporary: true`）のうち、自身が発行したセッションで作成されたものが削除される。（※注: 現在の実装では全一時ファイルが対象の可能性あり、要確認）

---

## 3. 機能要件（システム管理者）

### 3.1 運営者アカウント管理
- システム管理者ダッシュボードから、運営者アカウントの作成、一覧表示、削除ができる。

### 3.2 孤立データ管理
- **目的:** 運営者が削除された場合などに、所有者不明となった「孤立データ」を救済・整理する。
- **孤立した撮影者アカウント:**
    - 所有者（`created_by_operator_id`）がいない撮影者アカウントを検索して一覧表示する。
    - 一覧から、特定の撮影者を既存の運営者に割り当てるか、または完全に削除することができる。
- **孤立した画像グループ:**
    - 所有者（`operator_id`）がいない、または存在しない運営者に紐づく画像グループを検索して一覧表示する。
    - 一覧から、特定の画像グループに属する全画像をZIPファイルとして一括ダウンロードできる。
    - 一覧から、特定の画像グループを完全に削除できる。

---

## 4. API仕様（主要なもの）

### 4.1 認証・ログイン
- `/login` [GET]: 統合ログインページを表示。
- `/token` [POST]: ユーザー認証を行い、役割に応じて各ダッシュボードへリダイレクト。`access_token`をCookieにセット。
- `/logout` [POST]: ログアウト処理。Cookieを削除し、ログインページへリダイレクト。
- `/api/v1/login/token` [POST]: APIクライアント向け。認証情報と引き換えにBearerトークンをJSONで返す。

### 4.2 運営者用API (`/admin`)
- `/api/photographers` [GET, POST, DELETE]: 撮影者の作成、一覧取得、削除。
- `/api/groups` [GET]: 自身に紐づく画像グループの一覧をJSONで取得。
- `/api/items` [GET]: 指定した`group_id`に属する画像アイテム一覧をHTMLで取得。

### 4.3 システム管理者用API (`/system_admin`)
- `/api/operators` [GET, POST, DELETE]: 運営者の作成、一覧取得、削除。
- `/api/orphaned-photographers` [GET, DELETE]: 孤立した撮影者の検索と削除。
- `/api/photographers/{id}/assign-operator` [PUT]: 孤立した撮影者に運営者を割り当て。
- `/api/orphaned-image-groups` [GET, DELETE]: 孤立した画像グループの検索と削除。
- `/api/image-groups/download/{group_id}` [GET]: 孤立した画像グループをZIP形式でダウンロード。

---

## 5. ディレクトリ構成

```
FastAPI_mongoDB_10/
├── crud/
│   └── user_crud.py
├── documents/
├── routers/
│   ├── admin.py
│   ├── auth.py
│   ├── pages.py
│   ├── photographer.py
│   └── system_admin.py
├── services/
├── static/
├── templates/
│   ├── admin/
│   ├── photographer/
│   ├── system_admin/
│   ├── index.html
│   └── login.html
├── auth.py
├── create_operator.py
├── create_system_admin.py
├── db.py
├── dependencies.py
├── main.py
├── schemas.py
└── 製作日誌2.txt
```

---

## 6. 使用技術

- Python 3.11+
- FastAPI
- MongoDB / Pymongo
- GridFS
- Pillow
- qrcode
- Jinja2
- Bootstrap

---

## 7. 将来的な展望

- 登録画像のメタデータ修正機能の追加
- グループへのユーザー招待機能
- 画像単位でのコメントやフィードバック機能
- 本登録データのCSV出力や帳票PDF化などの確認機能の追加