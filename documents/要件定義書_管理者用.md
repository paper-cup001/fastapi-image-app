# レトロゲーム商品画像アップローダー 要件定義書（管理者用）

---

## 1. 概要

撮影・登録された商品画像やメタデータを管理者が確認・管理できるWeb管理画面を提供する。

- 撮影前の初期設定（group\_id入力とQRコード表示）
- 管理者による強制初期化機能（撮影者のセッションを初期化し、一時保存画像を削除）
- MongoDB内の登録済み画像情報の検索
- 撮影者が少人数（1〜3名）である前提に基づいた簡素な構成
- TEST_MODEが利用できる。テストモードの操作は通常操作と変わらないが、撮影者のアップロード画像は破棄されてダミー画像が使用される。
---

## 2. 機能要件

### 2.1 QRコード生成

- 管理者がgroup_idを手動入力できる
- 入力されたgroup_idを含むURLをQRコードとして生成し、その場でブラウザに表示
- QRコードは保存不要（都度表示）
- スマートフォンの画面提示やPCブラウザでの印刷を前提とする

### 2.2 強制初期化

- 管理者が「初期化」を実行すると、GridFSに保存されている画像のうち `temporary: true` フラグが付いたものが全て削除される。
- これにより、撮影者が途中で離脱するなどしてサーバーに残り続けた一時ファイルをクリーンアップする。
- 同時に、サーバーメモリ上の仮登録リスト（`TEMP_IMAGES`）もクリアされる。

### 2.3 MongoDB検索と詳細表示

- group_idや撮影日などの条件でMongoDB内の登録済み画像情報を検索可能
- 検索結果に画像のサムネイル、title, platform, jan_code などのメタ情報を表示
- 検索結果の各アイテムをクリックすると、詳細ページに遷移し、登録されている最大10枚の画像とメタデータを確認可能
- 詳細ページには「検索結果に戻る」リンクがあり、検索条件を保持した状態で戻れる
- 削除ボタンをクリックすると削除されて、検索結果に戻る

### 2.4 テストモード
- テストモードでは、撮影者のアップロード画像は破棄され、ダミー画像が使用される。
- main.py の `TEST_MODE` フラグをTrueに設定することで有効化
- ダミー画像の背景は、利用端末のuser_short_idを元にランダムに選択

### 2.5 グループID毎の統計情報
- グループIDごとに、アップロード済み、未アップロードの件数を集計して表示する。
- アップロード率（％）も合わせて表示する。
- アップロード率が100%のグループを非表示にするフィルタリング機能を持つ。
- 各グループの画像一覧ページへ直接遷移できるボタンを設置する。
- グループ単位で、登録されているすべての画像とメタデータを一括で削除する機能を持つ。削除前には確認ダイアログを表示する。

---

## 3. 非機能要件

- サーバーはFastAPIで実装
- MongoDBを主要なデータソースとして使用
- Jinja2テンプレートエンジンを使用
- モバイル・PC両対応UI（Bootstrapなどで実装）
- 認証機能（ログイン等）は当初実装しないが、将来的に拡張可能な構成とする


---

## 4. 管理用API仕様

### 4.1 `/admin/generate_qr` [GET/POST]

- **概要**: group_idを元に撮影者用URLのQRコードを生成・表示
- **パラメータ**: group_id（POST）
- **レスポンス**: QRコード画像をHTMLで表示

### 4.2 `/admin/search` [GET]

- **概要**: MongoDB内の本登録済み画像を検索
- **パラメータ**: group_id, date, file_uploaded
- **レスポンス**: 検索結果（画像サムネイル、メタ情報付き）

### 4.3  `/admin/detail/{item_id}` [GET]

- **概要**: 特定レコードの詳細情報を表示
-**パラメータ**: item_id（MongoDBのObjectId）, group_id, date（検索条件復元用）
-**レスポンス**: 最大10枚の登録画像とメタデータをHTMLで表示

### 4.4 `/admin/force_reset` [POST]

- **概要**: GridFS内のすべての一時ファイル（`temporary: true`）を削除する
- **レスポンス**: 削除件数を含むメッセージをHTMLで表示

### 4.5 `/admin/temp_files` [GET]

- **概要**: 現在GridFSに保存されている一時ファイルの一覧をJSONで返す（管理画面のUI表示用）
- **レスポンス**: `{ "files": [{"filename": "..."}] }`

### 4.6 `/admin/statistics` [GET]

- **概要**: グループIDごとの統計情報（アップロード済み件数、未アップロード件数、合計件数、アップロード率）をHTMLで表示する。
- **レスポンス**: 統計情報を含むHTMLページ。

### 4.7 `/admin/delete_group/{group_id}` [POST]

- **概要**: 指定されたgroup_idに関連するすべてのドキュメントとGridFS内の画像ファイルを削除する。
- **パラメータ**: group_id
- **レスポンス**: 削除結果のメッセージをJSONで返す。

---

## 5. ディレクトリ構成案（撮影者用と統一）

```
FastAPI_mongoDB/
├── main.py
├── db.py     ← MongoDB接続設定
├── routers/
│   ├── photographer.py
│   └── admin.py
├── services/
│   ├── image_processing.py
│   └── dummy_image.py
├── templates/
│   ├── index.html                ← ポータル画面（撮影者/管理者の選択）
│   ├── photographer/
│   │   └── upload.html
│   └── admin/
│       ├── dashboard.html
│       ├── generate_qr.html
│       ├── force_reset.html
│       ├── search.html
│       ├── detail.html
│       └── statistics.html
├── static/
│   └── dummy_image.png
├── temp_images/
├── requirements.txt
└── requirements_spec.md
```

---

## 6. 使用技術

- Python 3.8+
- FastAPI
- MongoDB
- Pillow
- qrcode
- Jinja2
- Bootstrap または jQuery（フロントエンド）


---

## 7. 将来的な展望

- 登録画像の削除・修正機能の追加
- 利用者ログ（誰がいつアップロードしたか）の導入
- 本登録データのCSV出力や帳票PDF化などの確認機能の追加
- 本番運用時には認証・アクセス制限の実装
