# レトロゲーム商品画像アップローダー 要件定義書（撮影者用）

---

## 1. 概要

スマートフォン等を用いて、レトロゲーム商品の画像を撮影・アップロードするためのWebアプリケーションを提供する。

- 撮影者は管理者から提供されたQRコードを読み取り、group_idを含むURLで撮影画面にアクセスする。
- 撮影画像はフロントエンドで自動縮小・トリミングされた後、サーバーに一時保存され、撮影者の操作によって本登録（MongoDB登録）される。
- 撮影操作はシンプルなボタンインターフェースで提供され、最大10枚までの画像を扱う。

---

## 2. 機能要件

### 2.1 操作フローとUI構成

- 初期画面では「撮影開始」ボタンのみ表示。
- 「撮影開始」を押すと、以下の3つのボタンが表示される：
  - 「撮影」
  - 「取り消し」
  - 「撮影終了」
- 「撮影」ボタンでカメラ撮影または画像アップロードを行う。
  - **撮影画像はフロントエンド（ブラウザ）でトリミング → FastAPIへ送信 → サムネイル生成 → 一時保存**
  - Base64形式のサムネイルを受信し、画面上に表示
  - 最大10枚まで撮影可能。10枚に達すると「撮影」ボタンは非表示になる
- 「取り消し」は、最後に撮影された画像を削除する（仮登録中のものに限る）
- 「撮影終了」で、本登録（MongoDBへの保存）処理を行う

#### 品質・コメント入力欄

- 撮影画面には「品質（quality）」の選択欄（セレクトボックス）が表示される。
  - 品質は「未確認」「故障 or 販売不可」「傷や汚れあり」などの選択肢から選ぶ。
  - 新規撮影時は「未確認（0）」が初期値となる。
- 「コメント（comment）」のチェックボックス入力欄が表示される。
  - 「箱説なし」「箱なし」「説明書なし」「付属品欠品」「箱いたみ」「説明書いたみ」「バッテリー切れ」「ケースにヒビ・割れ」「その他」など複数選択可。
  - 新規撮影時はすべて未選択となる。
- 「撮影終了」時、選択した品質・コメントも画像情報とともにMongoDBへ保存される。

---

### 2.2 仮登録画像処理

- 撮影された画像は、まず**フロントエンド（ブラウザ上）で標準のブラウザAPI（Image, Canvas）とQRコードを用いて自動縮小・トリミング**が行われる。
- QRコードが3つ以上認識できた場合にトリミングが実行される。認識できない場合は、元の画像がそのまま使用される。
- トリミング後の画像は正方形に整形される。
- **トリミング後の画像がサーバーにアップロード**され、GridFSに `temporary: true` というフラグ付きで一時保存される。
- ファイル名には group_id と user_short_id を含め、タイムスタンプ付きで命名される（例：groupid_userid_20250623112233.jpg）。
- サーバーはアップロードされた画像からサムネイル（base64形式）を生成して返却し、UIに即時表示する。
- 一時的なファイルリストは TEMP_IMAGES（メモリ管理）により管理される。

### 2.3 本登録処理

- 撮影終了時にMongoDBの images コレクションへ本登録を行う。
- 本登録時、対象画像のGridFS内ドキュメントから `temporary: true` フラグが `false` に更新される。
- 本登録時には以下の情報を保存：

    group_id  
    user_short_id  
    images: 各画像に対して filename, file_id（GridFSのID）, file_uploaded  
    title,  
    platform,  
    description,  
    jan_code  
    created_at  
    status,  
    meta_added  
    quality（品質）  
    comment（コメント、配列）

- MongoDBのスキーマ例：
  ```json
  {
    "_id" : ObjectId("6859dd25354173dd1c64aa19"),
    "group_id" : "sample_01",
    "user_short_id" : "77aepdkx",
    "images" : [
      {
        "filename" : "sample_01_77aepdkx_20250624080247929867.jpg",
        "file_id" : "6859dd17354173dd1c64aa15",
        "file_uploaded" : false
      }
    ],
    "title" : "",
    "platform" : "",
    "description" : "",
    "jan_code" : "",
    "created_at" : "2025-06-23T23:03:01.563250",
    "quality" : "2",
    "comment" : ["箱説なし", "箱いたみ"],
    "meta_added" : false
  }
  ```

### 2.4 撮影者識別（user_short_id）

- 撮影者の端末ごとに短縮ID（user_short_id）を自動生成し、localStorage に保存する。
- すべてのAPIリクエストで user_short_id を送信する。

### 2.5 管理者による強制初期化への対応（同期・安全機能）

**目的:**
管理者が管理画面から「強制初期化」を実行し、サーバー上の一時ファイルが削除された際に、撮影者の画面にその状態をリアルタイムで反映させ、操作の不整合を防ぐための機能。この機能により、撮影者が存在しないデータを操作しようとしてエラーに遭遇するのを防ぐ。

**シナリオ:**
1.  撮影者が撮影を開始し、画面上に一時保存された画像のサムネイルが表示されている。
2.  その裏で、管理者が「強制初期化」を実行し、サーバー上の一時ファイルが削除される。
3.  撮影者が「撮影」「取り消し」「撮影終了」など、何らかの操作を行う。
4.  その操作をトリガーに、クライアント（ブラウザ）はサーバーに現在の一時ファイルリストを問い合わせる。
5.  クライアントは、自身の画面にサムネイルが表示されているにもかかわらず、サーバー上のファイルリストが空であることを検知する。
6.  この状態を「管理者による削除」と判断し、「管理者により画像が削除されました。初期画面に戻ります。」という警告メッセージを表示する。
7.  撮影者の画面をサムネイルや入力情報がないクリーンな初期状態にリセットし、撮影者が混乱することなく操作を再開できるようにする。

---

## 3. 非機能要件

- サーバーはFastAPIで実装。
- MongoDBを画像情報の保存先とし、画像本体はGridFSへ保存。
- **画像処理はフロントエンドでは標準のブラウザAPI（Image, Canvas）とQRコード検出（OpenCV.jsまたはバックエンド）で行い、バックエンドではPillow (サムネイル生成など) とOpenCV-Python (QRコード検出・トリミング) で行う。なお、`upload_old.html`は`opencv.js`に非対応の古いスマートフォン向けに、画像処理をバックエンドで行うための代替手段として提供される。bootstrap4を利用**
- CORS対応（開発時は全許可、本番は制限推奨）。
- テンプレートエンジンはJinja2を利用。
- スマートフォンブラウザでの快適な利用を前提にUIを設計する。

---

## 4. API仕様

### 4.1 `/temp_upload` [POST]

- **概要**: **フロントエンドでトリミング済みの画像を受信し、** GridFSに一時保存後、サムネイルを生成して返却。
- **レスポンス**: { thumbnail, filename, user_short_id }

※ TEMP_IMAGESに記録するだけで、物理ファイル保存は行わない

### 4.2 `/temp_delete` [POST]

- **概要**: 最後に追加された仮登録画像を削除。
- **パラメータ**: group_id, filename
- **レスポンス**: `{ deleted: true }`

### 4.3 `/finalize_upload` [POST]

- **概要**: 一時保存画像をMongoDBに本登録。
- **パラメータ**: group_id, filenames[], user_short_id, quality, comment[]
- **レスポンス**: `{ success: true/false, message? }`

---

## 5. ディレクトリ構成例（統一構成）

```
FastAPI_mongoDB/
├── main.py
├── db.py     ← MongoDB接続設定
├── routers/
│   ├── photographer.py
│   └── admin.py
├── services/
│   ├── image_processing.py
│   └── dummy_image.py
├── templates/
│   ├── index.html                ← ポータル画面（撮影者/管理者の選択）
│   ├── photographer/
│   │   └── upload.html
│   └── admin/
│       ├── dashboard.html
│       ├── generate_qr.html
│       ├── force_reset.html
│       ├── search.html
│       └── detail.html
├── static/
│   └── dummy_image.png
├── temp_images/
├── requirements.txt
└── requirements_spec.md
```

---

## 6. 使用技術

- Python 3.8+
- FastAPI
- MongoDB
- Pillow
- **OpenCV-Python**
- **OpenCV.js (QRコード検出・トリミング処理、またはバックエンドでの代替)**
- Jinja2
- jQuery

---

## 7. 補足・将来的な展望

- 撮影者単位の撮影履歴・ログの導入可能性あり。
- 撮影ミス対策として、サムネイルの拡大確認機能の追加も検討。
- 本番運用時にはセキュリティ強化（CORS制限、IP制限など）を実施。認証機能は実装済み。
- temp_images/ フォルダは現状では不要ですが、TEMP_IMAGESによる 撮影中の仮登録リストのUI制御に使われるため、フォルダ自体を残していても構いません（ただしファイル保存は行わない）。
- 品質として数値を入れる
- 品質関係でメモを入れたい。例えば「箱説明書なし」「箱説明書あり」「箱説明書あり（箱が破損）」など。その場合は音声入力を検討
