【注意】このドキュメントには、過去のバージョンのシーケンス図が含まれています。最新の機能や認証フローについては、本文書や`api仕様書.txt`の内容を優先してください。

---

## システム管理者による孤立データ管理

```mermaid
sequenceDiagram
    participant Admin as システム管理者
    participant Front as 管理画面(JS)
    participant API as FastAPIサーバー
    participant DB as データベース
    participant GridFS as GridFS

    Admin->>Front: 「孤立した画像グループを検索」ボタン押下
    Front->>API: GET /system_admin/api/orphaned-image-groups
    API->>DB: usersコレクションから全運営者IDを取得
    API->>DB: imagesコレクションを検索 (operator_idが存在しない or 無効なID)
    API->>Front: 孤立グループのリスト(JSON)を返却
    Front->>Admin: 孤立グループ一覧を表示

    Admin->>Front: 特定グループの「ダウンロード」ボタン押下
    Note over Admin, Front: ブラウザは直接ダウンロード用URLにアクセス
    Admin->>API: GET /system_admin/api/image-groups/download/{group_id}
    API->>DB: 該当の孤立グループに属する画像ドキュメントを検索
    API->>GridFS: 該当の画像ファイルを取得
    API->>API: 取得した画像をメモリ上でZIPファイルに圧縮
    API->>Admin: ZIPファイルをストリーミングで返却

    Admin->>Front: 特定グループの「削除」ボタン押下
    Front->>API: DELETE /system_admin/api/image-groups/{group_id}
    API->>DB: 該当の孤立グループに属する画像ドキュメントを検索
    API->>GridFS: 関連する画像ファイルをすべて削除
    API->>DB: 該当の画像ドキュメントをすべて削除
    API->>Front: 204 No Content
    Front->>Front: 画面のリストを更新
end
```

---

## ログイン・ログアウト (ブラウザ)

```mermaid
sequenceDiagram
    participant User as ユーザー(ブラウザ)
    participant Front as ログイン画面(HTML)
    participant API as FastAPIサーバー

    User->>Front: メールアドレス・パスワード入力し「ログイン」
    Front->>API: POST /token (username, password)
    API->>API: パスワード検証
    alt 認証成功
        API->>API: JWT生成 & Cookieにセット
        API->>User: HTTP 303 Redirect (Location: /<role>/dashboard)
        User->>API: GET /<role>/dashboard (リダイレクトに従う)
        API->>User: ダッシュボード画面表示
    else 認証失敗
        API->>User: HTTP 303 Redirect (Location: /login?error=...)
        User->>Front: エラーメッセージ付きでログイン画面表示
    end

    User->>Front: 「ログアウト」ボタン押下
    Front->>API: POST /logout
    API->>User: HTTP 303 Redirect (Location: /login) (Cookie削除)
    User->>Front: ログインページ表示
end
```

---

## 撮影者のシーケンス図

```mermaid
sequenceDiagram
    participant User as 撮影者(スマホ)
    participant Front as フロントエンド(JS)
    participant API as FastAPIサーバー
    participant GridFS as MongoDB/GridFS
    participant DB as imagesコレクション

    User->>Front: QRコード読み取り (group_idとoperator_idを含むURL)
    Front->>API: GET /photographer/upload.html?...
    API->>Front: 撮影ページHTML返却

    loop 最大10回まで
        User->>Front: 「撮影」ボタン押下
        Front->>API: POST /photographer/temp_upload (画像, group_id, operator_id)
        API->>API: ファイル名生成 ({operator_id}_{group_id}_{...})
        API->>GridFS: 画像を一時保存 (operator_idもメタデータに含む)
        API->>Front: サムネイル等を返却
        Front->>Front: サムネイル表示
    end

    User->>Front: 「撮影終了」ボタン押下
    Front->>API: POST /photographer/finalize_upload (group_id, operator_id, filenames_data[], ...)
    API->>GridFS: 画像のtemporaryフラグをfalseに更新
    API->>DB: imagesコレクションに本登録 (operator_idも記録)
    API->>Front: 登録完了通知
end
```

---

## 運営者のシーケンス図

```mermaid
sequenceDiagram
    participant Admin as 運営者(ブラウザ)
    participant Front as 管理画面(HTML/JS)
    participant API as FastAPIサーバー
    participant DB as MongoDB

    %% --- 撮影者アカウント管理 ---
    Admin->>Front: 「撮影者アカウント管理」画面表示
    Front->>API: GET /admin/api/photographers (Cookie認証)
    API->>DB: usersコレクション検索 (role: photographer, created_by_operator_id: ログイン中運営者のID)
    API->>Front: 撮影者リスト(JSON)返却
    Front->>Front: 一覧表示

    %% --- 登録画像の階層検索 ---
    Admin->>Front: 「登録画像一覧」にアクセス
    Front->>API: GET /admin/api/groups (Cookie認証)
    API->>DB: imagesコレクション検索 (operator_id: ログイン中運営者のID)
    API->>Front: グループ一覧(JSON)を返却
    Front->>Front: フォルダ一覧を動的生成

    Admin->>Front: 特定のフォルダをクリック
    Front->>API: GET /admin/api/items?group_id=... (Cookie認証)
    API->>DB: imagesコレクション検索 (group_idとoperator_idで絞り込み)
    API->>Front: 商品一覧(HTML)を返却
    Front->>Front: 画面を商品一覧に切り替え
end
```

---

## 外部接続のシーケンス図

**【警告】** 以下のエンドポイントは、現状では複数運営者環境に対応していません。`group_id`でデータを取得する際に、他の運営者のデータが混在する可能性があります。利用には十分な注意が必要です。

```mermaid
sequenceDiagram
    participant Ext as 外部システム(n8n/FileMaker等)
    participant API as FastAPIサーバー
    participant DB as MongoDB(images, GridFS)

    Ext->>API: GET /external_api/search_unuploaded_items?group_id=...
    API->>DB: imagesコレクション検索(db_uploaded: false, group_id: ...)
    Note right of API: この検索はoperator_idで絞り込まれていない！
    API->>Ext: JSON(未処理アイテム一覧)

end
```