<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ä¸€æ™‚ä¿å­˜å‰Šé™¤ - ç®¡ç†è€…ç”»é¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="/static/css/custom.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">ğŸ§¹ ä¸€æ™‚ä¿å­˜ç”»åƒã®å…¨å‰Šé™¤</h1>
        <a href="/admin/dashboard" class="btn btn-secondary">â† æˆ»ã‚‹</a>
    </div>

    <div id="status-message" class="alert d-none" role="alert"></div>

    <hr class="my-4" />

    <h5>ğŸ—‚ GridFSã«ä¿å­˜ã•ã‚ŒãŸä¸€æ™‚ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§</h5>
    <ul id="temp-files" class="list-group mb-4"></ul>
    <p>ã“ã®æ©Ÿèƒ½ã¯ã€æ’®å½±ä¸­ã«ãƒ–ãƒ©ã‚¦ã‚¶å†èª­è¾¼ã‚’ã™ã‚‹ãªã©ã—ã¦ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ­£å¼ã«ç™»éŒ²ã•ã‚Œãªã„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€ãã‚Œã‚‰ã®æ¶ˆå»ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚</p>
    <p>
      ç®¡ç†è€…ãŒä¸€æ‹¬å‰Šé™¤ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€GridFSã®
      <code>temporary=true</code>ãªãƒ•ã‚¡ã‚¤ãƒ«ã¨ã€
      ãƒ¡ãƒ¢ãƒªä¸Šã®ä»®ç™»éŒ²ãƒªã‚¹ãƒˆï¼ˆ<code>TEMP_IMAGES</code>ï¼‰ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã™ã€‚
    </p>

    <div class="d-flex mb-4 gap-2">
      <button id="delete-all-btn" class="btn btn-danger">
        ä¸€æ™‚ç”»åƒã‚’å…¨ã¦å‰Šé™¤
      </button>
    </div>
  </div>

  <script>
    function showMessage(msg, type) {
      const alertBox = $("#status-message");
      alertBox
        .removeClass()
        .addClass(`alert alert-${type}`)
        .text(msg)
        .removeClass("d-none");
    }

    function loadTempFiles() {
      // ç®¡ç†ç”¨APIã¨ã—ã¦ /admin/temp_files (GET) ã‚’ç”¨æ„ã—ã¦ãŠãæƒ³å®š
      $.getJSON("/admin/temp_files", function (data) {
        const list = $("#temp-files").empty();
        if (!data.files || data.files.length === 0) {
          list.append(
            '<li class="list-group-item text-muted">ä¸€æ™‚ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>'
          );
        } else {
          data.files.forEach((file) => {
            list.append(`<li class="list-group-item">ğŸ–¼ ${file.filename}</li>`);
          });
        }
      }).fail(function () {
        showMessage("âš ï¸ ä¸€æ™‚ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", "warning");
      });
    }

    $("#delete-all-btn").on("click", function () {
      if (
        !confirm("GridFSã®ä¸€æ™‚ç”»åƒã¨ä»®ç™»éŒ²ãƒªã‚¹ãƒˆã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã€‚æ’®å½±ä½œæ¥­ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ãªã„ã“ã¨ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")
      ) {
        return;
      }

      $.ajax({
        url: "/admin/force_reset",
        type: "POST",
        success: function (data) {
          showMessage(data.message || "âœ… ä¸€æ™‚ç”»åƒã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã—ãŸã€‚", "success");
          loadTempFiles();
        },
        error: function (xhr) {
          const msg = xhr.responseJSON?.error || "âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
          showMessage(msg, "danger");
        },
      });
    });

    // åˆå›èª­ã¿è¾¼ã¿æ™‚ã«ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º
    $(document).ready(function () {
      loadTempFiles();
    });
  </script>
</body>
</html>
