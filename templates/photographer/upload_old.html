<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒ¬ãƒˆãƒ­ã‚²ãƒ¼ãƒ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <style>
    #thumbnails .img-thumbnail {
      width: 100%;
      height: auto;
      object-fit: contain;
      display: block;
      margin: 0 auto;
    }
    @media (max-width: 576px) {
      #thumbnails .img-thumbnail {
        max-width: 98vw;
      }
    }
    .btn-full { width: 100%; }
    .btn-half { width: 49%; }
  </style>
</head>
<body class="container py-3">

  <h1 class="mb-4">ğŸ“· å•†å“ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h1>
  <div>
    <div class="form-group">
      <label for="group_id_input" class="font-weight-bold">ã‚°ãƒ«ãƒ¼ãƒ—ID:</label>
      <input type="text" id="group_id_input" class="form-control">
    </div>
    <span id="uuid-display" class="text-muted"></span>
  </div>
  
  <!-- å“è³ªãƒ»ã‚³ãƒ¡ãƒ³ãƒˆé¸æŠï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³1ã¤ã«çµ±åˆï¼‰ -->
  <div class="accordion mb-4" id="qualityCommentAccordion">
    <div class="card">
      <div class="card-header" id="headingQualityComment">
        <h2 class="mb-0">
          <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseQualityComment" aria-expanded="false" aria-controls="collapseQualityComment">
            å“è³ªãƒ»ã‚³ãƒ¡ãƒ³ãƒˆã‚’é¸æŠ
          </button>
        </h2>
      </div>
      <div id="collapseQualityComment" class="collapse" aria-labelledby="headingQualityComment" data-parent="#qualityCommentAccordion">
        <div class="card-body">
          <!-- å“è³ªé¸æŠ -->
          <div class="mb-3">
            <label for="quality" class="form-label">å“è³ª:</label>
            <select id="quality" name="quality" class="form-control">
              <option value="0" selected>0: æœªç¢ºèª</option>
              <option value="1">1: æ•…éšœ or è²©å£²ä¸å¯</option>
              <option value="2">2: å‚·ã‚„æ±šã‚Œã‚ã‚Š</option>
              <option value="3">3: ã‚„ã‚„å‚·ã‚„æ±šã‚Œã‚ã‚Š</option>
              <option value="4">4: å‚·ã‚„æ±šã‚Œã¯ã‚ãšã‹</option>
              <option value="5">5: æœªä½¿ç”¨å“</option>
              <option value="6">6: æ–°å“ or æœªé–‹å°å“</option>
            </select>
          </div>
          <!-- ã‚³ãƒ¡ãƒ³ãƒˆé¸æŠ -->
          <div class="mb-4">
            <label class="form-label">ã‚³ãƒ¡ãƒ³ãƒˆ:</label><br>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="no-box-manual" value="ç®±èª¬ãªã—">
              <label class="form-check-label" for="no-box-manual">ç®±èª¬ãªã—</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="no-box" value="ç®±ãªã—">
              <label class="form-check-label" for="no-box">ç®±ãªã—</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="no-manual" value="èª¬æ˜æ›¸ãªã—">
              <label class="form-check-label" for="no-manual">èª¬æ˜æ›¸ãªã—</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="no-accessory" value="ä»˜å±å“æ¬ å“">
              <label class="form-check-label" for="no-accessory">ä»˜å±å“æ¬ å“</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="box-damage" value="ç®±ã„ãŸã¿">
              <label class="form-check-label" for="box-damage">ç®±ã„ãŸã¿</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="manual-damage" value="èª¬æ˜æ›¸ã„ãŸã¿">
              <label class="form-check-label" for="manual-damage">èª¬æ˜æ›¸ã„ãŸã¿</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="battery-dead" value="ãƒãƒƒãƒ†ãƒªãƒ¼åˆ‡ã‚Œ">
              <label class="form-check-label" for="battery-dead">ãƒãƒƒãƒ†ãƒªãƒ¼åˆ‡ã‚Œ</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="case-damage" value="ã‚±ãƒ¼ã‚¹ã«ãƒ’ãƒ“ãƒ»å‰²ã‚Œ">
              <label class="form-check-label" for="case-damage">ã‚±ãƒ¼ã‚¹ã«ãƒ’ãƒ“ or ã‚±ãƒ¼ã‚¹å‰²ã‚Œ</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="misc" value="ãã®ä»–">
              <label class="form-check-label" for="misc">ãã®ä»–</label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="shoot-section" style="display: none;">
    <form id="shoot-form" enctype="multipart/form-data">
      <input type="file" id="shoot-file" name="file" accept="image/*" capture="environment" style="display: none;" />
      <input type="hidden" id="group_id" name="group_id" value="sample_01" />
    </form>

    <div>
      <h2 class="h5">ã‚µãƒ ãƒã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæœ€å¤§10æšï¼‰</h2>
      <div id="thumbnails" class="row mb-5"></div>
    </div>
  </div>

  <div id="bottom-buttons" class="fixed-bottom bg-white border-top p-3">
    <button id="start-new" class="btn btn-primary btn-full">æ–°è¦æ’®å½±</button>
    <div id="shoot-controls" style="display: none;">
      <div class="mb-2">
        <button type="button" id="shoot-btn" class="btn btn-primary btn-full mb-2">æ’®å½±</button>
      </div>
      <div class="d-flex justify-content-between">
        <button type="button" id="cancel-btn" class="btn btn-warning btn-half">å–ã‚Šæ¶ˆã—</button>
        <button type="button" id="finish-btn" class="btn btn-success btn-half">æ’®å½±çµ‚äº†</button>
      </div>
    </div>
  </div>

  <script>
    $(document).ready(function(){

      function generateShortID() {
        return Math.random().toString(36).substr(2, 8);
      }

      var userShortID = localStorage.getItem('user_short_id');
      if (!userShortID) {
        userShortID = generateShortID();
        localStorage.setItem('user_short_id', userShortID);
      }
      $('#uuid-display').text('ã‚ãªãŸã®ç«¯æœ«ID: ' + userShortID);

      function getQueryParam(name) {
          name = name.replace(/[[\\]]/, "\\\[").replace(/[[\\]]/, "\\\]");
          var regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
          var results = regex.exec(location.search);
          return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
      }

      var urlGroupId = getQueryParam('group_id');
      if (urlGroupId) {
        $('#group_id_input').val(urlGroupId);
      } else {
        $('#group_id_input').val('sample_001');
      }
      var groupId = $('#group_id_input').val();

      function showGroupId() {
        // No longer needed, as the input field shows the value
      }
      function updateGroupId() {
        groupId = $('#group_id_input').val();
      }
      updateGroupId();

      $('#group_id_input').on('change', function() {
        updateGroupId();
      });

      var thumbnails = [];
      function checkAdminDeleteAndResetIfNeeded() {
        var thumbnailCount = thumbnails.length;
        if (thumbnailCount === 0) return;
        
        $.getJSON('/photographer/temp_list', { group_id: groupId }, function (data) {
          var tempFiles = data.files || [];
          var isTempEmpty = tempFiles.length === 0;
          var hasMyFile = false;
          for (var i = 0; i < tempFiles.length; i++) {
              if (tempFiles[i].indexOf(userShortID) > -1) {
                  hasMyFile = true;
                  break;
              }
          }
          if (isTempEmpty || !hasMyFile) {
            alert('âš ï¸ ç®¡ç†è€…ã«ã‚ˆã‚Šç”»åƒãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚åˆæœŸç”»é¢ã«æˆ»ã‚Šã¾ã™ã€‚');
            thumbnails = [];
            updateThumbnails();
            $('#shoot-section').hide();
            $('#shoot-controls').hide();
            $('#start-new').show();
          }
        });
      }
      $('#start-new').on('click', function () {
        thumbnails = [];
        $('#thumbnails').empty();
        $('#start-new').hide();
        $('#shoot-controls').show();
        $('#shoot-section').show();
        $('#shoot-btn').prop('disabled', false);
        updateGroupId();
        $('#quality').val('0');
        $('.card-body input[type=checkbox]').prop('checked', false);
      });

      $('#shoot-btn').on('click', function () {
        if (thumbnails.length >= 10) return;
        $('#shoot-file').click();
        checkAdminDeleteAndResetIfNeeded();
      });

      $('#shoot-file').on('change', function () {
        if (!this.files.length) return;
        var file = this.files[0];
        $(this).val('');
        uploadImage(file, file.name);
      });

      function uploadImage(fileOrBlob, filename) {
        var formData = new FormData();
        formData.append('file', fileOrBlob, filename);
        formData.append('group_id', groupId);
        formData.append('user_short_id', userShortID);
        formData.append('source_page', 'upload_old');

        $.ajax({
          url: '/photographer/temp_upload',
          type: 'POST',
          data: formData,
          processData: false,
          contentType: false,
          success: function (data) {
            if (data.thumbnail) {
              thumbnails.push(data);
              updateThumbnails();
              if (thumbnails.length >= 10) {
                $('#shoot-btn').prop('disabled', true);
              }
            }
            if (data.test_mode === true) {
              alert('ã“ã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã¯è©¦ç”¨ãƒ¢ãƒ¼ãƒ‰ã§ã‚ã‚‹ãŸã‚ã€ã‚ãªãŸã®ç”»åƒã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚');
            }
            checkAdminDeleteAndResetIfNeeded();
          },
          error: function () {
            alert('âŒ æ’®å½±ã‚¨ãƒ©ãƒ¼');
            checkAdminDeleteAndResetIfNeeded();
          }
        });
      }

      $('#cancel-btn').on('click', function () {
        if (thumbnails.length === 0) return;
        $.ajax({
          url: '/photographer/temp_delete',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ group_id: groupId, user_short_id: userShortID }),
          success: function (res) {
            thumbnails.pop();
            updateThumbnails();
            $('#shoot-btn').prop('disabled', thumbnails.length >= 10);
            checkAdminDeleteAndResetIfNeeded();
          },
          error: function () {
            alert('ç”»åƒã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            checkAdminDeleteAndResetIfNeeded();
          }
        });
      });

      $('#finish-btn').on('click', function () {
        if (thumbnails.length === 0) {
          alert('âŒ ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“');
          return;
        }
        var comments = [];
        $('#collapseQualityComment input[type=checkbox]:checked').each(function() {
          comments.push($(this).val());
        });

        var filenames = [];
        for(var i=0; i<thumbnails.length; i++) {
            filenames.push(thumbnails[i].filename);
        }

        $.ajax({
          url: '/photographer/finalize_upload',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({
            group_id: groupId,
            filenames: filenames,
            user_short_id: userShortID,
            quality: $('#quality').val(),
            comment: comments
          }),
          success: function (res) {
            if (res && res.success === false && res.message) {
              alert(res.message);
            }
            else {
              alert(thumbnails.length + 'æšã®ç”»åƒã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
            }
            thumbnails = [];
            updateThumbnails();
            $('#shoot-section').hide();
            $('#shoot-controls').hide();
            $('#start-new').show();
            $('#quality').val('0');
            $('.card-body input[type=checkbox]').prop('checked', false);
            checkAdminDeleteAndResetIfNeeded();
          },
          error: function (xhr) {
            var msg = 'âŒ ç™»éŒ²ã‚¨ãƒ©ãƒ¼';
            if (xhr.responseJSON && xhr.responseJSON.error) {
              msg = xhr.responseJSON.error;
            }
            alert(msg);
            checkAdminDeleteAndResetIfNeeded();
          }
        });
      });

      function updateThumbnails() {
        $('#thumbnails').empty();
        var reversedThumbnails = thumbnails.slice().reverse();
        for(var i=0; i<reversedThumbnails.length; i++) {
            var t = reversedThumbnails[i];
            $('#thumbnails').append('<div class="col-12 col-md-6 mb-3"><img src="data:image/jpeg;base64,' + t.thumbnail + '" class="img-thumbnail"></div>');
        }
      }

      window.addEventListener('beforeunload', function () {
        if (thumbnails.length > 0) {
          var filenames = [];
          for(var i=0; i<thumbnails.length; i++) {
              filenames.push(thumbnails[i].filename);
          }
          $.ajax({
              url: '/photographer/temp_delete',
              type: 'POST',
              contentType: 'application/json',
              data: JSON.stringify({ group_id: groupId, filenames: filenames }),
              async: false,
              success: function() { /* Do nothing */ },
              error: function() { /* Do nothing */ }
          });
        }
      });
    });
  </script>
</body>
</html>