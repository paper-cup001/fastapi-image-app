<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>レトロゲーム画像アップローダー</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <style>
    #thumbnails .img-thumbnail {
      width: 100%;
      height: auto;
      object-fit: contain;
      display: block;
      margin: 0 auto;
    }
    @media (max-width: 576px) {
      #thumbnails .img-thumbnail {
        max-width: 98vw;
      }
    }
    .btn-full { width: 100%; }
    .btn-half { width: 49%; }
  </style>
</head>
<body class="container py-3">

  <h1 class="mb-4">📷 商品画像のアップロード</h1>
  <div>
    <div class="form-group">
      <label for="group_id_input" class="font-weight-bold">グループID:</label>
      <input type="text" id="group_id_input" class="form-control">
    </div>
    <span id="uuid-display" class="text-muted"></span>
  </div>
  
  <!-- 品質・コメント選択（アコーディオン1つに統合） -->
  <div class="accordion mb-4" id="qualityCommentAccordion">
    <div class="card">
      <div class="card-header" id="headingQualityComment">
        <h2 class="mb-0">
          <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseQualityComment" aria-expanded="false" aria-controls="collapseQualityComment">
            品質・コメントを選択
          </button>
        </h2>
      </div>
      <div id="collapseQualityComment" class="collapse" aria-labelledby="headingQualityComment" data-parent="#qualityCommentAccordion">
        <div class="card-body">
          <!-- 品質選択 -->
          <div class="mb-3">
            <label for="quality" class="form-label">品質:</label>
            <select id="quality" name="quality" class="form-control">
              <option value="0" selected>0: 未確認</option>
              <option value="1">1: 故障 or 販売不可</option>
              <option value="2">2: 傷や汚れあり</option>
              <option value="3">3: やや傷や汚れあり</option>
              <option value="4">4: 傷や汚れはわずか</option>
              <option value="5">5: 未使用品</option>
              <option value="6">6: 新品 or 未開封品</option>
            </select>
          </div>
          <!-- コメント選択 -->
          <div class="mb-4">
            <label class="form-label">コメント:</label><br>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="no-box-manual" value="箱説なし">
              <label class="form-check-label" for="no-box-manual">箱説なし</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="no-box" value="箱なし">
              <label class="form-check-label" for="no-box">箱なし</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="no-manual" value="説明書なし">
              <label class="form-check-label" for="no-manual">説明書なし</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="no-accessory" value="付属品欠品">
              <label class="form-check-label" for="no-accessory">付属品欠品</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="box-damage" value="箱いたみ">
              <label class="form-check-label" for="box-damage">箱いたみ</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="manual-damage" value="説明書いたみ">
              <label class="form-check-label" for="manual-damage">説明書いたみ</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="battery-dead" value="バッテリー切れ">
              <label class="form-check-label" for="battery-dead">バッテリー切れ</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="case-damage" value="ケースにヒビ・割れ">
              <label class="form-check-label" for="case-damage">ケースにヒビ or ケース割れ</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="misc" value="その他">
              <label class="form-check-label" for="misc">その他</label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="shoot-section" style="display: none;">
    <form id="shoot-form" enctype="multipart/form-data">
      <input type="file" id="shoot-file" name="file" accept="image/*" capture="environment" style="display: none;" />
      <input type="hidden" id="group_id" name="group_id" value="sample_01" />
    </form>

    <div>
      <h2 class="h5">サムネイルプレビュー（最大10枚）</h2>
      <div id="thumbnails" class="row mb-5"></div>
    </div>
  </div>

  <div id="bottom-buttons" class="fixed-bottom bg-white border-top p-3">
    <button id="start-new" class="btn btn-primary btn-full">新規撮影</button>
    <div id="shoot-controls" style="display: none;">
      <div class="mb-2">
        <button type="button" id="shoot-btn" class="btn btn-primary btn-full mb-2">撮影</button>
      </div>
      <div class="d-flex justify-content-between">
        <button type="button" id="cancel-btn" class="btn btn-warning btn-half">取り消し</button>
        <button type="button" id="finish-btn" class="btn btn-success btn-half">撮影終了</button>
      </div>
    </div>
  </div>

  <script>
    $(document).ready(function(){

      function generateShortID() {
        return Math.random().toString(36).substr(2, 8);
      }

      var userShortID = localStorage.getItem('user_short_id');
      if (!userShortID) {
        userShortID = generateShortID();
        localStorage.setItem('user_short_id', userShortID);
      }
      $('#uuid-display').text('あなたの端末ID: ' + userShortID);

      function getQueryParam(name) {
          name = name.replace(/[[\\]]/, "\\\[").replace(/[[\\]]/, "\\\]");
          var regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
          var results = regex.exec(location.search);
          return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
      }

      var urlGroupId = getQueryParam('group_id');
      if (urlGroupId) {
        $('#group_id_input').val(urlGroupId);
      } else {
        $('#group_id_input').val('sample_001');
      }
      var groupId = $('#group_id_input').val();

      function showGroupId() {
        // No longer needed, as the input field shows the value
      }
      function updateGroupId() {
        groupId = $('#group_id_input').val();
      }
      updateGroupId();

      $('#group_id_input').on('change', function() {
        updateGroupId();
      });

      var thumbnails = [];
      function checkAdminDeleteAndResetIfNeeded() {
        var thumbnailCount = thumbnails.length;
        if (thumbnailCount === 0) return;
        
        $.getJSON('/photographer/temp_list', { group_id: groupId }, function (data) {
          var tempFiles = data.files || [];
          var isTempEmpty = tempFiles.length === 0;
          var hasMyFile = false;
          for (var i = 0; i < tempFiles.length; i++) {
              if (tempFiles[i].indexOf(userShortID) > -1) {
                  hasMyFile = true;
                  break;
              }
          }
          if (isTempEmpty || !hasMyFile) {
            alert('⚠️ 管理者により画像が削除されました。初期画面に戻ります。');
            thumbnails = [];
            updateThumbnails();
            $('#shoot-section').hide();
            $('#shoot-controls').hide();
            $('#start-new').show();
          }
        });
      }
      $('#start-new').on('click', function () {
        thumbnails = [];
        $('#thumbnails').empty();
        $('#start-new').hide();
        $('#shoot-controls').show();
        $('#shoot-section').show();
        $('#shoot-btn').prop('disabled', false);
        updateGroupId();
        $('#quality').val('0');
        $('.card-body input[type=checkbox]').prop('checked', false);
      });

      $('#shoot-btn').on('click', function () {
        if (thumbnails.length >= 10) return;
        $('#shoot-file').click();
        checkAdminDeleteAndResetIfNeeded();
      });

      $('#shoot-file').on('change', function () {
        if (!this.files.length) return;
        var file = this.files[0];
        $(this).val('');
        uploadImage(file, file.name);
      });

      function uploadImage(fileOrBlob, filename) {
        var formData = new FormData();
        formData.append('file', fileOrBlob, filename);
        formData.append('group_id', groupId);
        formData.append('user_short_id', userShortID);
        formData.append('source_page', 'upload_old');

        $.ajax({
          url: '/photographer/temp_upload',
          type: 'POST',
          data: formData,
          processData: false,
          contentType: false,
          success: function (data) {
            if (data.thumbnail) {
              thumbnails.push(data);
              updateThumbnails();
              if (thumbnails.length >= 10) {
                $('#shoot-btn').prop('disabled', true);
              }
            }
            if (data.test_mode === true) {
              alert('このウェブアプリは試用モードであるため、あなたの画像は保存されません。');
            }
            checkAdminDeleteAndResetIfNeeded();
          },
          error: function () {
            alert('❌ 撮影エラー');
            checkAdminDeleteAndResetIfNeeded();
          }
        });
      }

      $('#cancel-btn').on('click', function () {
        if (thumbnails.length === 0) return;
        $.ajax({
          url: '/photographer/temp_delete',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ group_id: groupId, user_short_id: userShortID }),
          success: function (res) {
            thumbnails.pop();
            updateThumbnails();
            $('#shoot-btn').prop('disabled', thumbnails.length >= 10);
            checkAdminDeleteAndResetIfNeeded();
          },
          error: function () {
            alert('画像の削除に失敗しました');
            checkAdminDeleteAndResetIfNeeded();
          }
        });
      });

      $('#finish-btn').on('click', function () {
        if (thumbnails.length === 0) {
          alert('❌ 画像がありません');
          return;
        }
        var comments = [];
        $('#collapseQualityComment input[type=checkbox]:checked').each(function() {
          comments.push($(this).val());
        });

        var filenames = [];
        for(var i=0; i<thumbnails.length; i++) {
            filenames.push(thumbnails[i].filename);
        }

        $.ajax({
          url: '/photographer/finalize_upload',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({
            group_id: groupId,
            filenames: filenames,
            user_short_id: userShortID,
            quality: $('#quality').val(),
            comment: comments
          }),
          success: function (res) {
            if (res && res.success === false && res.message) {
              alert(res.message);
            }
            else {
              alert(thumbnails.length + '枚の画像を登録しました');
            }
            thumbnails = [];
            updateThumbnails();
            $('#shoot-section').hide();
            $('#shoot-controls').hide();
            $('#start-new').show();
            $('#quality').val('0');
            $('.card-body input[type=checkbox]').prop('checked', false);
            checkAdminDeleteAndResetIfNeeded();
          },
          error: function (xhr) {
            var msg = '❌ 登録エラー';
            if (xhr.responseJSON && xhr.responseJSON.error) {
              msg = xhr.responseJSON.error;
            }
            alert(msg);
            checkAdminDeleteAndResetIfNeeded();
          }
        });
      });

      function updateThumbnails() {
        $('#thumbnails').empty();
        var reversedThumbnails = thumbnails.slice().reverse();
        for(var i=0; i<reversedThumbnails.length; i++) {
            var t = reversedThumbnails[i];
            $('#thumbnails').append('<div class="col-12 col-md-6 mb-3"><img src="data:image/jpeg;base64,' + t.thumbnail + '" class="img-thumbnail"></div>');
        }
      }

      window.addEventListener('beforeunload', function () {
        if (thumbnails.length > 0) {
          var filenames = [];
          for(var i=0; i<thumbnails.length; i++) {
              filenames.push(thumbnails[i].filename);
          }
          $.ajax({
              url: '/photographer/temp_delete',
              type: 'POST',
              contentType: 'application/json',
              data: JSON.stringify({ group_id: groupId, filenames: filenames }),
              async: false,
              success: function() { /* Do nothing */ },
              error: function() { /* Do nothing */ }
          });
        }
      });
    });
  </script>
</body>
</html>