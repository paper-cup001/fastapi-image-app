<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒ¬ãƒˆãƒ­ã‚²ãƒ¼ãƒ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="/static/css/custom.css">
  <style>
    #thumbnails {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    #thumbnails .img-thumbnail {
      width: 100%;
      max-width: 480px;
      height: auto;
      object-fit: contain;
      display: block;
      margin: 0 auto;
    }
    @media (max-width: 576px) {
      #thumbnails .img-thumbnail {
        max-width: 98vw;
      }
    }
    .btn-full { width: 100%; }
    .btn-half { width: 49%; }
  </style>
  <script>
    let cvInitialized = false;
    // Define onRuntimeInitialized globally or before opencv.js loads
    window.Module = {
      onRuntimeInitialized: function() {
        console.log('OpenCV.js is ready.');
        cvInitialized = true;
        $('#start-new').prop('disabled', false).text('æ–°è¦æ’®å½±'); // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
      }
    };
  </script>
  <!-- OpenCV.jsã®èª­ã¿è¾¼ã¿ -->
  <script async src="/static/opencv.js" type="text/javascript"></script>
</head>
<body class="bg-light">
  <div class="container py-3">
    <div class="row justify-content-center">
        <div class="col-12">
            <header class="pb-3 mb-4 border-bottom bg-white p-3 rounded-top">
                <a href="/photographer/upload.html" class="text-dark text-decoration-none">
                    <span class="fs-4">ğŸ“· å•†å“ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</span>
                </a>
                <div id="user-info" class="mt-2">
                    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </header>
            <main class="bg-white p-3 rounded-bottom">
              <div>
                <span id="group-id-display" class="fw-bold"></span>
                <span id="resolution-display" class="text-info ms-3"></span><br />
                <div class="form-check form-check-inline ms-3">
                  <input class="form-check-input" type="checkbox" id="fast-mode" value="fast">
                  <label class="form-check-label" for="fast-mode">ã¯ã‚„ã„</label>
                </div>
              </div>
              
              <!-- å“è³ªãƒ»ã‚³ãƒ¡ãƒ³ãƒˆé¸æŠï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³1ã¤ã«çµ±åˆï¼‰ -->
              <div class="accordion mb-4" id="qualityCommentAccordion">
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingQualityComment">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseQualityComment" aria-expanded="false" aria-controls="collapseQualityComment">
                      å“è³ªãƒ»ã‚³ãƒ¡ãƒ³ãƒˆã‚’é¸æŠ
                    </button>
                  </h2>
                  <div id="collapseQualityComment" class="accordion-collapse collapse" aria-labelledby="headingQualityComment" data-bs-parent="#qualityCommentAccordion">
                    <div class="accordion-body">
                      <!-- å“è³ªé¸æŠ -->
                      <div class="mb-3">
                        <label for="quality" class="form-label">å“è³ª:</label>
                        <select id="quality" name="quality" class="form-select">
                          <option value="0" selected>0: æœªç¢ºèª</option>
                          <option value="1">1: æ•…éšœ or è²©å£²ä¸å¯</option>
                          <option value="2">2: å‚·ã‚„æ±šã‚Œã‚ã‚Š</option>
                          <option value="3">3: ã‚„ã‚„å‚·ã‚„æ±šã‚Œã‚ã‚Š</option>
                          <option value="4">4: å‚·ã‚„æ±šã‚Œã¯ã‚ãšã‹</option>
                          <option value="5">5: æœªä½¿ç”¨å“</option>
                          <option value="6">6: æ–°å“ or æœªé–‹å°å“</option>
                        </select>
                      </div>
                      <!-- ã‚³ãƒ¡ãƒ³ãƒˆé¸æŠ -->
                      <div class="mb-4">
                        <label class="form-label">ã‚³ãƒ¡ãƒ³ãƒˆ:</label><br>
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="checkbox" id="no-box-manual" value="ç®±èª¬ãªã—">
                          <label class="form-check-label" for="no-box-manual">ç®±èª¬ãªã—</label>
                        </div>
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="checkbox" id="no-box" value="ç®±ãªã—">
                          <label class="form-check-label" for="no-box">ç®±ãªã—</label>
                        </div>
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="checkbox" id="no-manual" value="èª¬æ˜æ›¸ãªã—">
                          <label class="form-check-label" for="no-manual">èª¬æ˜æ›¸ãªã—</label>
                        </div>
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="checkbox" id="no-accessory" value="ä»˜å±å“æ¬ å“">
                          <label class="form-check-label" for="no-accessory">ä»˜å±å“æ¬ å“</label>
                        </div>
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="checkbox" id="box-damage" value="ç®±ã„ãŸã¿">
                          <label class="form-check-label" for="box-damage">ç®±ã„ãŸã¿</label>
                        </div>
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="checkbox" id="manual-damage" value="èª¬æ˜æ›¸ã„ãŸã¿">
                          <label class="form-check-label" for="manual-damage">èª¬æ˜æ›¸ã„ãŸã¿</label>
                        </div>
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="checkbox" id="battery-dead" value="ãƒãƒƒãƒ†ãƒªãƒ¼åˆ‡ã‚Œ">
                          <label class="form-check-label" for="battery-dead">ãƒãƒƒãƒ†ãƒªãƒ¼åˆ‡ã‚Œ</label>
                        </div>
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="checkbox" id="case-damage" value="ã‚±ãƒ¼ã‚¹ã«ãƒ’ãƒ“ãƒ»å‰²ã‚Œ">
                          <label class="form-check-label" for="case-damage">ã‚±ãƒ¼ã‚¹ã«ãƒ’ãƒ“ or ã‚±ãƒ¼ã‚¹å‰²ã‚Œ</label>
                        </div>
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="checkbox" id="misc" value="ãã®ä»–">
                          <label class="form-check-label" for="misc">ãã®ä»–</label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div id="shoot-section" style="display: none;">
                <form id="shoot-form" enctype="multipart/form-data">
                  <input type="file" id="shoot-file" name="file" accept="image/*" capture="environment" style="display: none;" />
                  <input type="hidden" id="group_id" name="group_id" value="sample_01" />
                  <input type="hidden" id="source_page" name="source_page" value="upload" />
                </form>

                <div>
                  <h2 class="h5">ã‚µãƒ ãƒã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæœ€å¤§10æšï¼‰</h2>
                  <div id="thumbnails" class="d-flex flex-wrap gap-2 mb-5"></div>
                </div>
              </div>
            </main>
        </div>
    </div>
  </div>

  <div id="bottom-buttons" class="fixed-bottom bg-white border-top p-3">
    <button id="start-new" class="btn btn-primary btn-full" disabled>æ–°è¦æ’®å½±</button>
    <div id="shoot-controls" style="display: none;">
      <div class="mb-2">
        <button type="button" id="shoot-btn" class="btn btn-primary btn-full mb-2">æ’®å½±</button>
      </div>
      <div class="d-flex justify-content-between gap-2">
        <button type="button" id="cancel-btn" class="btn btn-warning btn-half">å–ã‚Šæ¶ˆã—</button>
        <button type="button" id="finish-btn" class="btn btn-success btn-half">æ’®å½±çµ‚äº†</button>
      </div>
    </div>
  </div>

  <script>
    $(document).ready(function() {


    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    const urlGroupId = getQueryParam('group_id');
    if (urlGroupId) {
      $('#group_id').val(urlGroupId);
    }
    let groupId = $('#group_id').val();

    function showGroupId() {
      $('#group-id-display').text('ã‚°ãƒ«ãƒ¼ãƒ—ID: ' + groupId);
    }
    function updateGroupId() {
      groupId = $('#group_id').val();
      showGroupId();
    }
    updateGroupId();

    let thumbnails = [];
    function checkAdminDeleteAndResetIfNeeded() {
      // ã‚µãƒ ãƒã‚¤ãƒ«æ•°
      const thumbnailCount = thumbnails.length;
      if (thumbnailCount === 0) return;
      
      // temp_imagesã®ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—
      $.getJSON('/photographer/temp_list', { group_id: groupId }, function (data) { // temp_files -> temp_list
        const tempFiles = data.files || [];
        if (tempFiles.length === 0) {
          // ç®¡ç†è€…ã«ã‚ˆã‚‹å‰Šé™¤ã¨ã¿ãªã—ã¦åˆæœŸç”»é¢ã«æˆ»ã™
          alert('âš ï¸ ç®¡ç†è€…ã«ã‚ˆã‚Šç”»åƒãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚åˆæœŸç”»é¢ã«æˆ»ã‚Šã¾ã™ã€‚');
          thumbnails = [];
          updateThumbnails();
          $('#shoot-section').hide();
          $('#shoot-controls').hide();
          $('#start-new').show();
        }
      });
    }
    $('#start-new').on('click', function () {
      thumbnails = [];
      $('#thumbnails').empty();
      $('#start-new').hide();
      $('#shoot-controls').show();
      $('#shoot-section').show();
      $('#shoot-btn').prop('disabled', false);
      updateGroupId();

      // å“è³ªã‚’åˆæœŸå€¤ï¼ˆ0: æœªç¢ºèªï¼‰ã«æˆ»ã™
      $('#quality').val('0');
      // ã‚³ãƒ¡ãƒ³ãƒˆã®ãƒã‚§ãƒƒã‚¯ã‚’ã™ã¹ã¦å¤–ã™
      $('.accordion-body input[type=checkbox]').prop('checked', false);
      $('#resolution-display').text('');
    });

    $('#shoot-btn').on('click', function () {
      if (thumbnails.length >= 10) return;
      $('#shoot-file').click();
      // æ’®å½±æ™‚ã«ãƒã‚§ãƒƒã‚¯
      checkAdminDeleteAndResetIfNeeded();
    });

    $('#shoot-file').on('change', function () {
      if (!this.files.length) return;
      const file = this.files[0];
      $(this).val(''); // inputã‚’ãƒªã‚»ãƒƒãƒˆ

      if (!cvInitialized) {
        console.log('OpenCV.js is not initialized yet. cvInitialized:', cvInitialized);
        alert('OpenCV.jsãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        return;
      }
      console.log('OpenCV.js is initialized. Starting image processing.');

      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          const totalStartTime = performance.now(); // Start total timer

          console.log('img.onload fired.');

          const isFastMode = $('#fast-mode').is(':checked');
          const MAX_PIXELS = isFastMode ? 1200 : 1800; // Fast: 1200px, Normal: 1800px
          console.log(`Mode: ${isFastMode ? 'Fast' : 'Normal'}, MAX_PIXELS: ${MAX_PIXELS}`);

          let newWidth = img.width;
          let newHeight = img.height;

          if (img.width > MAX_PIXELS || img.height > MAX_PIXELS) {
              if (img.width > img.height) {
                  newWidth = MAX_PIXELS;
                  newHeight = Math.round((img.height * MAX_PIXELS) / img.width);
              } else {
                  newHeight = MAX_PIXELS;
                  newWidth = Math.round((img.width * MAX_PIXELS) / img.height);
              }
          }

          // ç”»åƒã‚’ä¸€æ™‚çš„ãªCanvasã«æç”»ã—ã¦OpenCVã«æ¸¡ã™
          const tempCanvas = document.createElement('canvas');
          tempCanvas.width = newWidth;
          tempCanvas.height = newHeight;
          const tempCtx = tempCanvas.getContext('2d');
          console.log('Before drawImage. img dimensions:', img.width, img.height, 'new dimensions:', newWidth, newHeight);
          tempCtx.drawImage(img, 0, 0, newWidth, newHeight);
          console.log('After drawImage.');

          const imreadStartTime = performance.now(); // Start imread timer
          console.log('Before cv.imread.');
          const src = cv.imread(tempCanvas);
          const imreadEndTime = performance.now(); // End imread timer
          console.log('After cv.imread. src dimensions:', src.cols, src.rows, 'Time:', (imreadEndTime - imreadStartTime).toFixed(2), 'ms');

          const dst = new cv.Mat();
          const gray = new cv.Mat(); // ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ç”»åƒç”¨

          const cvtColorStartTime = performance.now(); // Start cvtColor timer
          cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY); // ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ã«å¤‰æ›
          const cvtColorEndTime = performance.now(); // End cvtColor timer
          console.log('Gray Mat properties: cols=', gray.cols, ', rows=', gray.rows, ', type=', gray.type(), ', channels=', gray.channels(), 'Time:', (cvtColorEndTime - cvtColorStartTime).toFixed(2), 'ms');

          const qrcode = new cv.QRCodeDetector();
          const points = new cv.Mat();
          const decodedInfo = new cv.StringVector();

          try {
            const detectStartTime = performance.now(); // Start detect timer
            console.log('Before detectAndDecodeMulti.');
            qrcode.detectAndDecodeMulti(gray, decodedInfo, points); // ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ç”»åƒã‚’æ¸¡ã™
            const detectEndTime = performance.now(); // End detect timer
            console.log('After detectAndDecodeMulti. QR code detection result - decodedInfo size:', decodedInfo.size(), 'points rows:', points.rows, 'Time:', (detectEndTime - detectStartTime).toFixed(2), 'ms');

            const postDetectStartTime = performance.now(); // Start post-detection JS logic timer

            const validQrCodes = ["L1", "L2", "L3", "R1", "R2", "R3"];
            const dMarkerInt = {};

            for (let i = 0; i < decodedInfo.size(); ++i) {
              const info = decodedInfo.get(i);
              if (validQrCodes.includes(info)) {
                const pointData = [];
                for (let j = 0; j < points.cols; ++j) {
                  pointData.push({ x: points.data32F[i * points.cols * 2 + j * 2], y: points.data32F[i * points.cols * 2 + j * 2 + 1] });
                }
                dMarkerInt[info] = pointData;
              }
            }
            console.log('Filtered QR codes (dMarkerInt):', dMarkerInt);

            if (Object.keys(dMarkerInt).length < 3) {
              console.log("QRã‚³ãƒ¼ãƒ‰ãŒ3ã¤è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ¤œå‡ºã•ã‚ŒãŸæœ‰åŠ¹ãªQRã‚³ãƒ¼ãƒ‰:", Object.keys(dMarkerInt));
              // QRã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å…ƒã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
              uploadImage(file);
              return;
            }

            console.log("QRã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ", dMarkerInt);

            // logic_sample.pyã®find_corner_pointã‚’JavaScriptã§å®Ÿè£…
            function findCornerPoint(points, corner = "right") {
              if (points.length === 0) return null;

              let targetPoint = null;
              if (corner === "right") {
                // å³ä¸Šã®ç‚¹ã‚’é¸æŠï¼šxåº§æ¨™ã®æœ€å¤§å€¤ã¨yåº§æ¨™ã®æœ€å°å€¤ã‚’æŒã¤ç‚¹
                let maxX = -Infinity;
                let minY = Infinity;
                points.forEach(p => {
                  if (p.x > maxX) maxX = p.x;
                  if (p.y < minY) minY = p.y;
                });
                let minDist = Infinity;
                points.forEach(p => {
                  const dist = Math.sqrt(Math.pow(maxX - p.x, 2) + Math.pow(minY - p.y, 2));
                  if (dist < minDist) {
                    minDist = dist;
                    targetPoint = p;
                  }
                });
              } else {
                // å·¦ä¸Šã®ç‚¹ã‚’é¸æŠï¼šxåº§æ¨™ã®æœ€å°å€¤ã¨yåº§æ¨™ã®æœ€å°å€¤ã‚’æŒã¤ç‚¹
                let minX = Infinity;
                let minY = Infinity;
                points.forEach(p => {
                  if (p.x < minX) minX = p.x;
                  if (p.y < minY) minY = p.y;
                });
                let minDist = Infinity;
                points.forEach(p => {
                  const dist = Math.sqrt(Math.pow(minX - p.x, 2) + Math.pow(minY - p.y, 2));
                  if (dist < minDist) {
                    minDist = dist;
                    targetPoint = p;
                  }
                });
              }
              return targetPoint;
            }

            // logic_sample.pyã®æ²»å…·ã®å·¦å³ç¢ºå®šãƒ­ã‚¸ãƒƒã‚¯ã‚’JavaScriptã§å®Ÿè£…
            const centerX = src.cols / 2;
            let leftCount = 0;
            let rightCount = 0;
            for (const key in dMarkerInt) {
              dMarkerInt[key].forEach(p => {
                if (p.x < centerX) {
                  leftCount++;
                } else {
                  rightCount++;
                }
              });
            }

            let side = "";
            if (leftCount < rightCount) {
              side = "left";
            } else if (rightCount <= leftCount) {
              side = "right";
            } else {
              side = "undetermined";
            }
            console.log(`Detected side: ${side}`);

            const cornerPoints = [];
            for (const key in dMarkerInt) {
              const cornerPoint = findCornerPoint(dMarkerInt[key], side);
              if (cornerPoint) {
                cornerPoints.push(cornerPoint);
              }
            }
            console.log("ã‚³ãƒ¼ãƒŠãƒ¼ãƒã‚¤ãƒ³ãƒˆ", cornerPoints);

            const postDetectEndTime = performance.now(); // End post-detection JS logic timer
            console.log('Post-detection JS logic time:', (postDetectEndTime - postDetectStartTime).toFixed(2), 'ms');


            if (cornerPoints.length >= 3) {
              // ãƒˆãƒªãƒŸãƒ³ã‚°åº§æ¨™ã®æ±ºå®šã€‚X_MIN, X_MAX, Y_MIN, Y_MAX ã¯èª¿æ•´å€¤ã¨ã—ã¦å®šç¾©
              // TODO: ã“ã‚Œã‚‰ã®å€¤ã‚’é©åˆ‡ã«å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
              let offset = 10; // Default for normal
              if (quality === 'fast') {
                offset = 8;
              } else if (quality === 'large') {
                offset = 12;
              }
              const X_MIN = offset;
              const X_MAX = -offset;
              const Y_MIN = offset;
              const Y_MAX = -offset;

              const xMin = Math.min(...cornerPoints.map(p => p.x)) + X_MIN;
              const xMax = Math.max(...cornerPoints.map(p => p.x)) + X_MAX;
              const yMin = Math.min(...cornerPoints.map(p => p.y)) + Y_MIN;
              const yMax = Math.max(...cornerPoints.map(p => p.y)) + Y_MAX;

              const rect = new cv.Rect(xMin, yMin, xMax - xMin, yMax - yMin);
              const croppedImage = src.roi(rect);

              const imshowBlobStartTime = performance.now(); // Start imshow/blob timer
              // Canvasã«æç”»ã—ã¦Blobã«å¤‰æ›
              const canvas = document.createElement('canvas');
              cv.imshow(canvas, croppedImage);
              $('#resolution-display').text(`${croppedImage.cols}x${croppedImage.rows}`);
              canvas.toBlob(function(blob) {
                const croppedFile = new File([blob], file.name, { type: 'image/png' });
                uploadImage(croppedFile);
                const imshowBlobEndTime = performance.now(); // End imshow/blob timer (inside async callback)
                console.log('cv.imshow and canvas.toBlob time:', (imshowBlobEndTime - imshowBlobStartTime).toFixed(2), 'ms');
              }, 'image/png');

              croppedImage.delete();
            } else {
              console.log("ãƒãƒ¼ã‚«ãƒ¼ãŒ3ã¤èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸ");
              uploadImage(file); // ãƒˆãƒªãƒŸãƒ³ã‚°ã›ãšã«å…ƒã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            }
          } catch (err) {
            console.error("OpenCVå‡¦ç†ã‚¨ãƒ©ãƒ¼:", err);
            uploadImage(file); // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          } finally {
            src.delete();
            dst.delete();
            gray.delete(); // grayã‚’è§£æ”¾
            qrcode.delete();
            points.delete();
            decodedInfo.delete();
            const totalEndTime = performance.now(); // End total timer
            console.log('Total img.onload execution time:', (totalEndTime - totalStartTime).toFixed(2), 'ms');
          }
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });

    function uploadImage(fileToUpload) {
      const formData = new FormData();
      formData.append('file', fileToUpload);
      formData.append('group_id', groupId);

      $.ajax({
        url: '/photographer/temp_upload',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function (data) {
          if (data.thumbnail) {
            thumbnails.push(data);
            updateThumbnails();
            if (thumbnails.length >= 10) {
              $('#shoot-btn').prop('disabled', true);
            }
          }
          if (data.test_mode === true) {
            alert('ã“ã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã¯è©¦ç”¨ãƒ¢ãƒ¼ãƒ‰ã§ã‚ã‚‹ãŸã‚ã€ã‚ãªãŸã®ç”»åƒã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚');
          }
          checkAdminDeleteAndResetIfNeeded();
        },
        error: function () {
          alert('âŒ æ’®å½±ã‚¨ãƒ©ãƒ¼');
          checkAdminDeleteAndResetIfNeeded();
        }
      });
    }

    $('#cancel-btn').on('click', function () {
      if (thumbnails.length === 0) return;
      $.ajax({
        url: '/photographer/temp_delete',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ group_id: groupId }),
        success: function (res) {
          thumbnails.pop();
          updateThumbnails();
          $('#shoot-btn').prop('disabled', thumbnails.length >= 10);
          $('#resolution-display').text('');
          checkAdminDeleteAndResetIfNeeded();
        },
        error: function () {
          alert('ç”»åƒã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
          checkAdminDeleteAndResetIfNeeded();
        }
      });
    });

    $('#finish-btn').on('click', function () {
      if (thumbnails.length === 0) {
        alert('âŒ ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      const comments = [];
      $('#collapseQualityComment input[type=checkbox]:checked').each(function() {
        comments.push($(this).val());
      });

      $.ajax({
        url: '/photographer/finalize_upload',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
          group_id: groupId,
          filenames: thumbnails.map(t => t.filename),
          quality: $('#quality').val(),
          comment: comments
        }),
        success: function (res) {
          if (res && res.success === false && res.message) {
            alert(res.message);
          } else {
            alert(thumbnails.length + 'æšã®ç”»åƒã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
          }
          thumbnails = [];
          updateThumbnails();
          $('#shoot-section').hide();
          $('#shoot-controls').hide();
          $('#start-new').show();
          $('#quality').val('0');
          $('.accordion-body input[type=checkbox]').prop('checked', false);
          $('#resolution-display').text('');
          checkAdminDeleteAndResetIfNeeded();
        },
        error: function (xhr) {
          let msg = 'âŒ ç™»éŒ²ã‚¨ãƒ©ãƒ¼';
          if (xhr.responseJSON && xhr.responseJSON.error) {
            msg = xhr.responseJSON.error;
          }
          alert(msg);
          checkAdminDeleteAndResetIfNeeded();
        }
      });
    });

    function updateThumbnails() {
      $('#thumbnails').empty();
      thumbnails.slice().reverse().forEach(t => {
        $('#thumbnails').append(`<div class="col-12 col-md-6"><img src="data:image/jpeg;base64,${t.thumbnail}" class="img-thumbnail"></div>`);
      });
    }

    }); // End of $(document).ready()
  </script>

  <script>
      let currentUserRole = null; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã‚’ä¿æŒã™ã‚‹å¤‰æ•°

      // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹é–¢æ•°
      async function fetchCurrentUser() {
          try {
              const response = await fetch('/photographer/users/me');
              if (response.ok) {
                  const user = await response.json();
                  currentUserRole = user.role; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã‚’ä¿å­˜

                  let userInfoHtml = `<span class="me-3">ãƒ­ã‚°ã‚¤ãƒ³ä¸­: <strong>${user.email}</strong></span>`;

                  // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚’å…ˆã«è¿½åŠ 
                  userInfoHtml += `<button class="btn btn-sm btn-outline-secondary me-2" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>`;

                  // é‹å–¶è€…ã®å ´åˆã€ã‚°ãƒ¬ãƒ¼ã®ã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã®å³å´ã«è¿½åŠ 
                  if (currentUserRole === 'operator') {
                      userInfoHtml += `<a href="/admin/dashboard" class="btn btn-sm btn-secondary">â† æˆ»ã‚‹</a>`;
                  }

                  document.getElementById('user-info').innerHTML = userInfoHtml;

              } else {
                  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå–å¾—ã§ããªã„å ´åˆï¼ˆæœªãƒ­ã‚°ã‚¤ãƒ³ãªã©ï¼‰ã¯é©åˆ‡ãªãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸
                  window.location.href = '/photographer/login';
              }
          } catch (error) {
              console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
              window.location.href = '/photographer/login';
          }
      }

      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
      async function logout() {
          try {
              const response = await fetch('/logout', {
                  method: 'POST',
              });
              if (response.ok) {
                  alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚');
                  // å½¹å‰²ã«å¿œã˜ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆã‚’å¤‰æ›´
                  if (currentUserRole === 'operator') {
                      window.location.href = '/login';
                  } else {
                      window.location.href = '/photographer/login';
                  }
              } else {
                  alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
              }
          } catch (error) {
              console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
              alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
          }
      }

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
      document.addEventListener('DOMContentLoaded', fetchCurrentUser);
  </script>
</body>
</html>
